#!/bin/bash

# A function to get all the variables to show on main window.
function getvar() {
    CORE_FIRST=$(cat /proc/cpuinfo | awk '/^processor/{print $3}' | sed -n 1p)
    CORE_LAST=$(cat /proc/cpuinfo | awk '/^processor/{print $3}' | tail -1)
    UIDS=$(ls /run/user | head -1)
    DEFAULT_GOVERNOR=$(cat /var/lib/batman/default_cpu_governor)
    AVPOL=$(ls /sys/devices/system/cpu/cpufreq | wc -l)
    FIRSTPOL=$(ls /sys/devices/system/cpu/cpufreq | head -1)
    FIRSTPOLCORE=$(cat /sys/devices/system/cpu/cpufreq/$FIRSTPOL/related_cpus | cut -c1 -)
    LASTPOLCORE=$(cat /sys/devices/system/cpu/cpufreq/$FIRSTPOL/related_cpus | rev | cut -c1 -)
    DEFAULT_GPU_GOVERNOR=$(cat /var/lib/batman/default_gpu_governor)
    UPTIME=$(awk '{print int($1)/60}' /proc/uptime | cut -f 1 -d .)
    SCREEN=$(XDG_RUNTIME_DIR=/run/user/$UIDS/ wlr-randr | grep Enabled | cut -c 12-)
    CHARGE=$(upower -d | grep state | awk '!seen[$0]++' | cut -c 26- | sed -n 1p)
    CURRENT_CONFIG=$(cat /var/lib/batman/config)
    BATMANSTAT=$(systemctl is-active batman)
    PID=$(systemctl show --property MainPID --value batman)
    CPU_USAGE=$(awk '{u=$2+$4; t=$2+$4+$5; if (NR==1){u1=u; t1=t;} else print ($2+$4-u1) * 100 / (t-t1) ; }' <(grep 'cpu ' /proc/stat) <(sleep 0.5;grep 'cpu ' /proc/stat) | cut -d "." -f1)
}

# Function that shows values that do not change after the system is booted.
function permvar() {
    echo "UID:" $UIDS
    echo
    echo "First CPU core:" $CORE_FIRST
    echo
    echo "Last CPU core:" $CORE_LAST
    echo
    echo "Default CPU governor:" $DEFAULT_GOVERNOR
    echo
    echo "Default GPU governor:" $DEFAULT_GPU_GOVERNOR
    echo
    echo "available CPU policy groups:" $AVPOL
    echo
    echo "First CPU policy group:" $FIRSTPOL
    echo
    echo "First core $FIRSTPOL:" $FIRSTPOLCORE
    echo
    echo "Last core of $FIRSTPOL:" $LASTPOLCORE
}

# Function that shows values that do change often and need to get updated.
function tempvar() {
    echo
    echo "Batman is" $BATMANSTAT
    echo
    echo "Batman pid:" $PID
    echo
    echo "Current uptime in minutes:" $UPTIME
    echo
    echo "Current screen status:" $SCREEN
    echo
    echo "Current charging status:" $CHARGE
    echo
    echo "Current CPU usage:" $CPU_USAGE
    echo
    echo "Current config: "
    echo
    while IFS= read -r line; do echo $line && echo; done < /var/lib/batman/config
}

# Funtion that runs the main window.
function main() {
(
   while true;
   do
       getvar
       echo -e '\f'
       permvar
       tempvar
       sleep 1s
   done
) | yad --title batman --hscroll-policy=never --vscroll-policy=never --listen --auto-close --auto-kill --monitor --text-info \
   --button="Config page 1":"batman-gui config" \
   --button="Config page 2":"batman-gui config2" \
   --button="Restart":'pkexec systemctl restart batman' \
   --button="Stop":'pkexec systemctl stop batman'
}

# Function for first configuration page.
function config() {
(
   while true;
   do
       CONFIG=$(cat /var/lib/batman/config)
       echo -e '\f'
       echo "Powersave allows CPU go into powersaving."
       echo
       echo "Offlining is the process of CPU cores shutting down."
       echo "These two only activate when device is idling."
       echo "They also save a lot of battery."
       echo
       echo "MAX_CPU_USAGE indicates the max CPU usage for device"
       echo "that offline function compares against."
       echo
       echo "Make sure to restart the service on changes."
       echo
       echo "Current config: "
       echo
       while IFS= read -r line; do echo $line && echo; done < /var/lib/batman/config

       while true;
       do

           NEWCONFIG=$(cat /var/lib/batman/config)
           if [ "$CONFIG" == "$NEWCONFIG" ]; then
               sleep 0.5
           else
               break
           fi

       done

   done
   ) | yad --title "batman configurator" --hscroll-policy=never --vscroll-policy=never --listen --auto-close --auto-kill --monitor --text-info \
   --button="Powersave off":'sed -i "s/POWERSAVE.*/POWERSAVE=false/g" /var/lib/batman/config' \
   --button="Powersave on":'sed -i "s/POWERSAVE.*/POWERSAVE=true/g" /var/lib/batman/config' \
   --button="Offline off":'sed -i "s/OFFLINE.*/OFFLINE=false/g" /var/lib/batman/config' \
   --button="Offline on":'sed -i "s/OFFLINE.*/OFFLINE=true/g" /var/lib/batman/config'
}

# Function for second configuration page.
function config2() {
(
   while true;
   do
       CONFIG=$(cat /var/lib/batman/config)
       echo -e '\f'
       echo "GPUsave allows GPU go into powersaving."
       echo "This feature is still experimental."
       echo
       echo "Chargesave indicates whether or not put device to"
       echo "powersave when its charging up."
       echo
       echo "Make sure to restart the service on changes."
       echo
       echo "Current config: "
       echo
       while IFS= read -r line; do echo $line && echo; done < /var/lib/batman/config

       while true;
       do

           NEWCONFIG=$(cat /var/lib/batman/config)
           if [ "$CONFIG" == "$NEWCONFIG" ]; then
               sleep 0.5
           else
               break
           fi

       done
   done
   ) | yad --title "batman configurator" --hscroll-policy=never --vscroll-policy=never --listen --auto-close --auto-kill --monitor --text-info \
   --button="GPUsave off":'sed -i "s/GPUSAVE.*/GPUSAVE=false/g" /var/lib/batman/config' \
   --button="GPUsave on":'sed -i "s/GPUSAVE.*/GPUSAVE=true/g" /var/lib/batman/config' \
   --button="Chargesave off":'sed -i "s/CHARGESAVE.*/CHARGESAVE=false/g" /var/lib/batman/config' \
   --button="Chargesave on":'sed -i "s/CHARGESAVE.*/CHARGESAVE=true/g" /var/lib/batman/config'
}

function usage() {
   echo "Usage: 'batman-gui main' to launch the main window and 'batman config' to launch the first config window and 'batman config2' to launch the second config window."
}

# Let user pass arguments
"$@"

# If no argument was passed show help
if [ "$#" -eq 0 ]
then
    usage
    exit 0
fi
